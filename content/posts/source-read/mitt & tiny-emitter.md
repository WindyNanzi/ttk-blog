# é˜…è¯»ç¬”è®° | mitt & tiny-emitter

> è‹¥å·-æºç å…±è¯»æ´»åŠ¨-ç¬¬ 8 æœŸ

## 1. å‰è¨€

äº†è§£åˆ° `mitt` è¿™ä¸ªçŸ­å°ç²¾ç¾çš„åº“æ˜¯åœ¨ `vite` åˆšå‡ºä¸ä¹…ä¹‹åï¼Œæƒ³å°è¯•ä¸€ä¸‹ `vue3` çš„æ–°è¯­æ³•ï¼Œåœ¨é€”ä¸­å‘ç°åœ¨æ–°è¯­æ³•ä¸­è·¨ç»„ä»¶é€šè®¯ç›¸å¯¹å›°éš¾ã€‚é€šè¿‡ä¸Šç½‘æŸ¥é˜…ï¼Œäº†è§£åˆ°äº†è¿™ä¸ªåº“ã€‚ä¾¿åœ¨è‡ªå·±ç”¨æ¥ä½“éªŒ `vue3` çš„é¡¹ç›®ä¸­ä½¿ç”¨äº†å®ƒï¼š
![image.png](https://cdn.nlark.com/yuque/0/2021/png/283876/1639535739620-4f00a09c-029e-4047-bb06-01634526536a.png#clientId=u46be77dc-79a5-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=176&id=uea7e2105&margin=%5Bobject%20Object%5D&name=image.png&originHeight=244&originWidth=1032&originalType=binary&ratio=1&rotation=0&showTitle=false&size=51066&status=done&style=none&taskId=uf078859d-ecb8-4eb6-b672-ac509dd796f&title=&width=744)
åœ¨è¾ƒä¸ºå°å‹çš„é¡¹ç›®ä¸­ï¼Œæˆ–è€…æƒ³å¼€å‘åŸºäº `vue3` çš„ç»„ä»¶æˆ–å·¥å…·ï¼Œæˆ‘è§‰å¾—è¿™ä¸ªåº“æ˜¯æŒºä¸é”™çš„ã€‚å½“æ—¶ç½‘å‹ä¾¿è¯´è¿™ä¸ªåº“å¾ˆå°ä¸”æ˜“è¯»ï¼Œæ‰€ä»¥å½“æ—¶ä¾¿å»é˜…è¯»äº†ä¸€ä¸‹æºç ã€‚å¦‚ä»Šåˆåœ¨è‹¥å·å¤§ä½¬çš„æºç é˜…è¯»æ´»åŠ¨ä¸­çœ‹è§å®ƒçš„èº«å½±ï¼Œä¹Ÿç®—æ˜¯ç•¥æœ‰ç¼˜åˆ†å§ã€‚
â€‹

## 2. æ¦‚è¦

`mitt` å’Œ `tiny-emitter` ä¿©åº“åšçš„äº‹æƒ…å…¶å®å·®ä¸å¤šï¼š
**æ„é€ äº†ä¸€ä¸ªäº‹ä»¶çš„è°ƒåº¦ä¸­å¿ƒï¼š**

1. **è‡ªå®šä¹‰å¹¶ç»‘å®šäº‹ä»¶**
1. **è§¦å‘å·²å®šä¹‰çš„äº‹ä»¶**
1. **è§£é™¤å·²ç»‘å®šçš„äº‹ä»¶**

â€‹

å½“ç„¶å®ƒä»¬ä¹Ÿç•¥æœ‰ä¸åŒï¼š

1. `mitt` çš„æºç ä½¿ç”¨äº† typescriptï¼Œé‡‡ç”¨äº† es6 çš„è¯­æ³•ï¼Œè€Œ `tiny-emitter` ä½¿ç”¨çš„æ˜¯ es5 çš„è¯­æ³•
1. `mitt` ä½¿ç”¨äº† ESModule è¿›è¡Œæ¨¡å—å¯¼å‡ºï¼Œè€Œ `tiny-emitter` åˆ™æ˜¯ CommonJS
1. `mitt` ä¸­å®šä¹‰äº†é€šé…ç¬¦ `*` äº‹ä»¶ï¼Œè€Œ `tiny-emitter` ä¸­åˆ™æ˜¯å®šä¹‰äº† `once` äº‹ä»¶
1. `mitt` ä¸­çš„ `on` æ–¹æ³•ä»…éœ€è¦ä¼ é€’ äº‹ä»¶ç±»å‹ä¸äº‹ä»¶å¥æŸ„ä¸¤ä¸ªå‚æ•°ï¼Œè€Œ `tiny-emitter` ä¸­è¿˜å¯ä»¥é¢å¤–ä¼ é€’ä¸€ä¸ªå¥æŸ„ä¸Šä¸‹æ–‡çš„å‚æ•°ã€‚

â€‹

æ€»ä½“è€Œè¨€ï¼Œæˆ‘æ›´å–œæ¬¢ `mitt` è¿™ä¸ªåº“ï¼Œå®ƒçš„æºç ç›¸è¾ƒ `tiny-emitter` æ›´ä¸ºç®€æ´æ˜“è¯»ï¼ˆå‡å¦‚æŠ›å¼€ typescript çš„å­¦ä¹ æˆæœ¬ï¼‰ã€‚
â€‹

åœ¨è‹¥å·å¤§ä½¬å¯¹ç¬¬ 8 æœŸé˜…è¯»æºç çš„ä»‹ç»ä¸­ï¼Œè°ˆåˆ°é˜…è¯» `mitt` , `tiny-emitter` æ˜¯å¸Œæœ›å»äº†è§£ã€Œå‘å¸ƒ-è®¢é˜… ã€è®¾è®¡æ¨¡å¼ã€‚è‹¥éè¦è¾ƒçœŸçš„è¯ï¼Œæœ‰äººä¹Ÿè¯´è¿™æ˜¯ ã€Œè§‚å¯Ÿè€…ã€è®¾è®¡æ¨¡å¼ï¼Œä¸è¿‡ä¸å¦¨ç¢ï¼Œä¸»è¦è¿˜æ˜¯éœ€è¦çŸ¥é“å®ƒä»¬çš„åº”ç”¨åœºæ™¯ã€‚
â€‹

## 3. æ­£æ–‡

### 3.1 èŠèŠç±»ä¼¼çš„

ä¸»è¦è®²è®² `mitt` ,å…¶å®ä¸¤ä¸ªåº“éƒ½å·®ä¸å¤šã€‚é˜…è¯»æºç å¯ä»¥äº†è§£åˆ°ï¼Œä¸€ä¸ªäº‹ä»¶æ˜¯å¯ä»¥ç»‘å®š`on`å¤šä¸ªå¥æŸ„çš„ï¼Œåœ¨äº‹ä»¶è§¦å‘`emit`æ—¶ï¼ŒæŒ‰ç»‘å®šæ—¶åºä¾æ¬¡æ‰§è¡Œç»‘å®šçš„äº‹ä»¶å¥æŸ„ï¼Œä»æ–‡å­—ä¸Šå¯èƒ½ä¸å¤ªæ–¹ä¾¿ç†è§£ã€‚ä½†æ˜¯ä½¿ç”¨è¿‡ `jquery` çš„åŒå­¦ä¹Ÿè®¸ä¼šè§è¿‡å¦‚ä¸‹çš„ä»£ç ï¼š

```javascript
// å®é™…åœºæ™¯ä¸å»ºè®®è¿™æ ·ç»‘å®šäº‹ä»¶ ğŸ˜¯

var btn1 = $('#btn1');
btn1.on('click', fn1);
// ... é¢æ¡...
btn1.on('click', fn2);
```

å½“æˆ‘ä»¬ä½¿ç”¨ `jquery` ä¸º DOM å…ƒç´ ç»‘å®šäº‹ä»¶çš„æ—¶å€™ï¼Œå…¶å®ä¹Ÿæ˜¯å¯ä»¥ä¸ºåŒä¸€ä¸ªäº‹ä»¶ç±»å‹ç»‘å®šå¤šä¸ªå¥æŸ„çš„ã€‚
è¿™å…¶å®å’Œ `vue` ä¸­çš„åŒå‘ç»‘å®šæœ‰ç€å¼‚æ›²åŒå·¥ä¹‹å¦™ï¼Œ`vue` data ä¸­çš„ä¸€ä¸ªå±æ€§å˜åŒ–ï¼Œä¼šå¼•èµ·é¡µé¢å¤šä¸ªä¸ä¹‹ç»‘å®šçš„ DOM å…ƒç´ å‘ç”Ÿå˜åŒ–ï¼Œè¿™å¯ä»¥è§†ä¸º`vue` data çš„å±æ€§ï¼Œå®é™…ä¸Šç»´æŠ¤äº†å¤šä¸ªå¯ä»¥å¼•èµ· DOM å…ƒç´ å˜åŒ–çš„å¥æŸ„ã€‚å…¶å®é¢è¯•å®˜å¸¸çˆ±é—®çš„ï¼Œ`vue` åŒå‘ç»‘å®šçš„åŸç†ï¼Œå…¶ä¸­æœ‰ä¸€æ¡å°±æ˜¯ã€Œå‘å¸ƒ-è®¢é˜…ã€æ¨¡å¼ã€‚

### 3.2 mitt æºç 

ç”±äº`mitt`æºç å¹¶ä¸ç®—é•¿ï¼Œå’±å¯ä»¥ç›´æ¥æ¬è¿‡æ¥ã€‚å…¶å®æºç  `index.ts` å¾ˆå¤šä¸€éƒ¨åˆ†ä»£ç æ˜¯ä¸ºäº†ç±»å‹çº¦æŸã€‚æ¯”å¦‚é€šé…ç¬¦äº‹ä»¶å¥æŸ„ç±»å‹ï¼Œé€šé…ç¬¦äº‹ä»¶å¥æŸ„åˆ—è¡¨ç±»å‹...ã€‚æˆ‘ä»¬å¯ä»¥ä¸ç”¨ç‰¹åˆ«å…³å¿ƒè¿™äº›ä¸œè¥¿ï¼Œè€Œä¸“æ³¨äºé€»è¾‘æœ¬èº«ï¼š

```javascript
export default function mitt(all = new Map()) {
  return {
    all,
    // ç»‘å®š
    on(type, handle) {
      const handles = all.get(type);
      if (handles) {
        handles.push(handle);
      } else {
        all.set(type, [handle]);
      }
    },
    // è§£ç»‘
    off(type, handle) {
      const handles = all.get(type) || [];
      const idx = handles.indexOf(handle);
      if (idx > -1) {
        handles.remove(idx);
      } else {
        all.set(type, []);
      }
    },
    // è§¦å‘
    emit(type, evt) {
      const handles = all.get(type) || [];
      handles.forEach((handle) => handle(evt));

      // é€šé…ç¬¦äº‹ä»¶ï¼Œè¡¨ç¤ºæ‰€æœ‰äº‹ä»¶éƒ½ä¼šè§¦å‘å®ƒ
      const wildcardHandlers = all.get('*');
      wildcardHandlers.forEach((handle) => handle(type, evt));
    },
  };
}
```

å®é™…ä¸Š `mitt` ä¸­ `emitt` æ–¹æ³•é•¿è¿™æ ·ï¼š

```typescript
function emit<Key extends keyof Events>(type: Key, evt?: Events[Key]) {
  let handlers = all!.get(type);
  if (handlers) {
    (handlers as EventHandlerList<Events[keyof Events]>)
      .slice()
      .map((handler) => {
        handler(evt!);
      });
  }

  handlers = all!.get('*');
  if (handlers) {
    (handlers as WildCardEventHandlerList<Events>).slice().map((handler) => {
      handler(type, evt!);
    });
  }
}
```

ä¸Šè¾¹è¿™ä¸ª `mitt` æ–¹æ³•ä¸­ï¼Œæˆ‘æœ‰ä¸¤ä¸ªåœ°æ–¹ä¸å¤ªç†è§£ï¼š

1. ä¸ºä»€ä¹ˆ `handles` è¦è°ƒç”¨ `slice` æ–¹æ³•
1. ä¸ºä»€ä¹ˆ `handles` è¦ä½¿ç”¨ `map` æ–¹æ³•è€Œä¸æ˜¯ `forEach` æ–¹æ³•æ¥æ‰§è¡Œæ•°ç»„ä¸­çš„äº‹ä»¶å¥æŸ„ï¼Œå› ä¸º`forEach` æ‰§è¡Œæ•ˆç‡æ¯” `map` è¦å¿«äº›ï¼Œä¹Ÿå…¼å…·å¯è¯»æ€§

â€‹

~~ç¬¬ä¸€ä¸ªé—®é¢˜æˆ‘é€šè¿‡æŸ¥è¯¢ git è®°å½•äº†è§£åˆ°ï¼Œå¯èƒ½å­˜åœ¨æŸç§æƒ…å†µï¼Œ~~`~~emit~~`~~ æ–¹æ³•æ‰§è¡Œæ—¶ï¼Œè‹¥æ•°ç»„ä¸­çš„æ–¹æ³•è¿˜ä¸ºæ‰§è¡Œå®Œï¼Œæ­¤æ—¶åˆæ‰§è¡Œäº† ~~`~~off~~`~~ æ–¹æ³•ï¼Œé‚£å°±ä¼šå¯¼è‡´äº†å¯èƒ½ä¼šæœ‰äº‹ä»¶å¥æŸ„æœªèƒ½è¢«æ‰§è¡Œï¼Œæ‰€ä»¥éœ€è¦ä¸€ä¸ªæ–°çš„æ•°ç»„ä¿å­˜æ‰€æœ‰çš„å¥æŸ„ã€‚æˆ‘ä¸ªäººè§‰å¾—è¿™ç§æƒ…å†µç›¸å¯¹æç«¯ï¼Œåªå­˜åœ¨å¼‚æ­¥æ“ä½œé¢‘ç¹çš„æ—¶å€™å§ã€‚~~
![image.png](https://cdn.nlark.com/yuque/0/2021/png/283876/1639556214366-5924ade3-bc36-4939-b5d5-9a65905db014.png#clientId=ud976c969-2d07-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=391&id=ufdda9eec&margin=%5Bobject%20Object%5D&name=image.png&originHeight=535&originWidth=1019&originalType=binary&ratio=1&rotation=0&showTitle=false&size=50009&status=done&style=none&taskId=u7382f2a7-6ba9-4f6d-9a11-80b955d372d&title=&width=745.5)
æ˜¾ç„¶è¿™æ ·æ˜æ˜¾çš„é—®é¢˜å¾ˆæ—©å°±æœ‰äººè€ƒè™‘åˆ°äº†ï¼Œåœ¨æŸ¥è¯¢ git è®°å½•ä¹‹å‰ï¼Œä¹Ÿå¯ä»¥æ ¹æ®å…³é”®å­—åœ¨ `issues` ä¸­è¿›è¡Œæœç´¢ï¼Œå¯èƒ½ä¼šæ›´æœ‰æ•ˆç‡çš„æ‰¾åˆ°ç­”æ¡ˆã€‚
[https://github.com/developit/mitt/pull/109](https://github.com/developit/mitt/pull/109)
å¤§æ„å°±æ˜¯ï¼š

1. `slice` æ˜¯ä¸ºäº†é˜²æ­¢äº‹ä»¶å¥æŸ„å‰é¢çš„è¯­å¥å¯¹å¥æŸ„ç§»é™¤åï¼Œå¥æŸ„æ•°ç»„ä¸‹æ ‡æ”¹åŠ¨ï¼Œå¯èƒ½é€ æˆè·³è¿‡éƒ¨åˆ†å¥æŸ„çš„æ‰§è¡Œ
1. `map` åˆ™æ˜¯ä¸ºäº†ä»£ç æ›´å¥½å‹ç¼©ï¼Ÿ[https://github.com/developit/mitt/pull/110](https://github.com/developit/mitt/pull/110)

![image.png](https://cdn.nlark.com/yuque/0/2021/png/283876/1639560606930-c3900a84-2b0d-453d-9359-e879b9c1ee21.png#clientId=ud976c969-2d07-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=426&id=u63d4e6e3&margin=%5Bobject%20Object%5D&name=image.png&originHeight=690&originWidth=1164&originalType=binary&ratio=1&rotation=0&showTitle=false&size=76733&status=done&style=none&taskId=ubbdeac85-5bc7-402f-8dd1-c1d85507d5c&title=&width=718)

è‹¥å·å¤§ä½¬ç›´æ¥æŒ‡å‡º [@simonezhou(simonezhou)](/simonezhou) åŒå­¦çš„ [ç¬”è®°](https://www.yuque.com/simonezhou/kb/lww7bx) ä¸­ä¹Ÿæ‰¾åˆ°äº†è¿™æ ·å†™çš„ç­”æ¡ˆã€‚çœŸæ˜¯å¾ˆå‰å®³å‘€ ğŸ‘
![image.png](https://cdn.nlark.com/yuque/0/2021/png/283876/1639560524444-ce77c7a9-c238-44dd-a4d2-5d5d3c85c1c8.png#clientId=ud976c969-2d07-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=304&id=u6c9f7986&margin=%5Bobject%20Object%5D&name=image.png&originHeight=607&originWidth=1432&originalType=binary&ratio=1&rotation=0&showTitle=false&size=66994&status=done&style=none&taskId=u476b0b0c-9b7a-4474-94b6-5e534373066&title=&width=716)

## 4. å¿ƒå¾—

æœ¬æƒ³å†èŠèŠã€Œå‘å¸ƒ-è®¢é˜…ã€æ¨¡å¼ï¼Œä¸è¿‡å‘ç°è‡ªå·±åœ¨å¹³æ—¶çš„å¼€å‘ä¸­é²œæœ‰ç”¨åˆ°å„ç±»è®¾è®¡æ¨¡å¼ã€‚è™½ç„¶æœ‰å¤§ä½¬è¯´ã€Œè®¾è®¡æ¨¡å¼ä¸æ˜¯é“¶å¼¹ã€ï¼Œä¸è¿‡æŒæ¡å…¶æ€æƒ³åœ¨æŸäº›æƒ…å†µä¸‹ç¡®å®èƒ½èµ·åˆ°æ„æƒ³ä¸åˆ°çš„ä½œç”¨å§ã€‚å…¶å®å¾ˆå¤šæƒ…å†µä¸‹ï¼Œæˆ‘æ¯”è¾ƒæ›´å€¾å‘äºå°†å¤æ‚çš„é€»è¾‘æŠ½è±¡ä¸å°è£…ï¼Œè®©ä¸€ä¸ªä¸ªåŠŸèƒ½å˜å¾—å•ä¸€åŒ–ï¼Œå®¹æ˜“ç®¡ç†å’Œè§‚çœ‹ï¼ŒåŸºæœ¬å¯ä»¥è§£å†³å¾ˆå¤šé—®é¢˜ã€‚`mitt` å’Œ `tiny-emitter` åˆ™æ˜¯æ›´é«˜çº¬åº¦çš„æŠ½è±¡æ€è€ƒï¼Œåªæœ‰æ›´å–œæ¬¢å»æ€è€ƒï¼Œæ›´å–œæ¬¢å°†æƒ³æ³•ä»˜è¯¸åœ¨è¡ŒåŠ¨ä¸Šï¼Œå¯¹ä»£ç ä»¥æŒä¹‹ä»¥æ’çš„å»ç¹åŒ–ç®€ï¼Œå°è£…ï¼Œå•ä¸€åŒ–ï¼Œè¯­ä¹‰åŒ–ï¼Œæ‰èƒ½æ‰“é€ å‡ºåˆé€‚çš„ã€Œè®¾è®¡æ¨¡å¼ã€å§ã€‚
ä¸€ç‚¹å¿ƒå¾—ï¼Œä¸çŸ¥æ‰€è¨€ã€‚ğŸ¦
